name: CI

on:
  push:
    branches: [ main ]
  pull_request:
  workflow_dispatch:
  schedule:
    - cron: '0 3 * * *'  # Daily at 3am UTC (temporary: detect upstream PR changes)

jobs:
  lint:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install clang-format
        run: brew install clang-format

      - name: Check formatting
        run: |
          make fmt
          git diff --exit-code || (echo "Code is not formatted. Run 'make fmt' and commit." && exit 1)

  test:
    runs-on: macos-26
    steps:
      - uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go/go.mod
          cache: false

      - name: Cache Go build cache
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Caches/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-build-${{ hashFiles('go/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-build-

      - name: Install dependencies
        run: brew install clang-format bats-core

      - name: Cache Swift packages
        uses: actions/cache@v4
        with:
          path: |
            swift/.build
            swift/Package.resolved
          key: ${{ runner.os }}-swift-${{ hashFiles('swift/Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-swift-

      - name: Get vz branch commit hash
        id: vz-commit
        run: |
          COMMIT=$(git ls-remote https://github.com/norio-nomura/vz feat-add-vmnet-network-device-attachment | cut -f1)
          echo "commit=$COMMIT" >> $GITHUB_OUTPUT
          echo "vz branch commit: $COMMIT"

      - name: Cache vz dependency
        id: cache-vz
        uses: actions/cache@v4
        with:
          path: ${{ runner.workspace }}/norio-nomura/vz
          key: ${{ runner.os }}-vz-${{ hashFiles('go/go.mod') }}-${{ steps.vz-commit.outputs.commit }}
          restore-keys: |
            ${{ runner.os }}-vz-

      - name: Setup Go test dependency
        run: |
          if [ ! -d "../norio-nomura/vz" ]; then
            git clone https://github.com/norio-nomura/vz ../norio-nomura/vz
          fi
          cd ../norio-nomura/vz
          CURRENT=$(git rev-parse HEAD 2>/dev/null || echo "")
          EXPECTED="${{ steps.vz-commit.outputs.commit }}"
          if [ "$CURRENT" != "$EXPECTED" ]; then
            echo "Updating to latest commit: $EXPECTED"
            git fetch origin
            git checkout feat-add-vmnet-network-device-attachment
            git reset --hard origin/feat-add-vmnet-network-device-attachment
          fi
          make

      - name: Build
        run: make

      - name: Install
        run: make install

      - name: Test
        run: make test
