name: CI

on:
  push:
    branches: [ main ]
  pull_request:
  workflow_dispatch:
  schedule:
    - cron: '0 3 * * *'  # Daily at 3am UTC (temporary: detect upstream PR changes)

jobs:
  lint:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: brew install shellcheck clang-format

      - name: Lint
        run: make lint

  test:
    runs-on: macos-26
    env:
      SKIP_DOCC_PLUGIN: "1"
    steps:
      - uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go/go.mod
          cache: false

      - name: Install dependencies
        run: brew install clang-format bats-core tree

      # Hash Swift version + Package.resolved to invalidate cache when either changes.
      # Example version: "Apple Swift version 6.1 (swiftlang-6.1.0.110.21 clang-1700.0.13.3)"
      - name: Compute Swift cache key
        id: swift-cache
        run: |
          hash=$({ swift --version; cat swift/Package.resolved; } | shasum -a 256 | awk '{print $1}')
          echo "key=${{ runner.os }}-swift-$hash" >> $GITHUB_OUTPUT

      - name: Cache Swift packages
        uses: actions/cache@v4
        with:
          path: |
            swift/.build
            ~/.swiftpm/cache
          key: ${{ steps.swift-cache.outputs.key }}

      - name: Cache Go build
        uses: actions/cache@v4
        with:
          path: |
            ~/go/pkg/mod
            ~/Library/Caches/go-build
          key: ${{ runner.os }}-go-${{ hashFiles('go/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Get vz branch commit hash
        id: vz
        run: |
          COMMIT=$(git ls-remote https://github.com/norio-nomura/vz feat-add-vmnet-network-device-attachment | cut -f1)
          echo "commit=$COMMIT" >> $GITHUB_OUTPUT
          echo "vz branch commit: $COMMIT"

      # No restore-keys: partial match would have wrong commit, requiring fetch anyway
      - name: Cache vz dependency
        id: cache-vz
        uses: actions/cache@v4
        with:
          path: ${{ runner.workspace }}/norio-nomura/vz
          key: ${{ runner.os }}-vz-${{ steps.vz.outputs.commit }}

      - name: Clone vz dependency
        if: steps.cache-vz.outputs.cache-hit != 'true'
        run: |
          git clone \
            --branch feat-add-vmnet-network-device-attachment \
            https://github.com/norio-nomura/vz \
            ../norio-nomura/vz

      - name: Build
        run: make

      - name: Install
        run: make install

      - name: Test
        run: make test

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: vmnet-broker.log
          path: /Library/Logs/vmnet-broker/vmnet-broker.log

      - name: Uninstall
        run: make uninstall
