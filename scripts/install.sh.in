#!/bin/bash
# SPDX-FileCopyrightText: The vmnet-broker authors
# SPDX-License-Identifier: Apache-2.0

# NOTE: Generated from scripts/install.sh.in - do not edit

set -eu -o pipefail

#@INCLUDE_COMMON@

if [[ $EUID -ne 0 ]]; then
    fatal "This script must be run as root"
fi

trap 'fatal "Install failed"' ERR

if service_installed; then
    pid=$(service_pid)
    if [[ "$pid" != "-" ]]; then
        fatal "Service $service_name is currently running (service_pid: $pid)"
    fi

    debug "Booting out service $service_name"
    run launchctl bootout "system/$service_name" || true
    run rm -f "$launchd_dir/$service_name.plist"
    info "Booted out service $service_name"
fi

unique_id=$(find_unique_id)

if ! group_exists; then
    debug "Creating system group $group_name id $unique_id"
    run dscl . -create /Groups/$group_name
    run dscl . -create /Groups/$group_name PrimaryGroupID $unique_id
    info "Created system group $group_name"
fi

if ! user_exists; then
    debug "Creating system user $user_name id $unique_id"
    run dscl . -create /Users/$user_name
    run dscl . -create /Users/$user_name UniqueID $unique_id
    run dscl . -create /Users/$user_name PrimaryGroupID $unique_id
    run dscl . -create /Users/$user_name UserShell /usr/bin/false
    run dscl . -create /Users/$user_name RealName "Vmnet Broker Daemon"
    run dscl . -create /Users/$user_name NFSHomeDirectory /var/empty
    info "Created system user $user_name"
fi

debug "Installing broker in $install_dir"
run mkdir -p "$install_dir"
run install vmnet-broker "$install_dir"
run install uninstall.sh "$install_dir"
run install LICENSE "$install_dir"
run chown -R root:wheel "$install_dir"
info "Installed broker in $install_dir"

debug "Creating log directory $log_dir"
run mkdir -p "$log_dir"
run chown -R $user_name:$user_name "$log_dir"
run chmod 0755 "$log_dir"
info "Created log directory $log_dir"

debug "Installing service $launchd_dir/$service_name.plist"
run cp $service_name.plist "$launchd_dir"
run chown root:wheel "$launchd_dir/$service_name.plist"
run chmod 0644 "$launchd_dir/$service_name.plist"
info "Installed service $launchd_dir/$service_name.plist"

debug "Bootstrapping service $service_name"
run launchctl bootstrap system "$launchd_dir/$service_name.plist"
info "Bootstrapped service $service_name"

notice "Install completed"
